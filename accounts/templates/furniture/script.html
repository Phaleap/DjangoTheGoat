<script>

document.addEventListener("click", function (e) {
    const rmBtn = e.target.closest(".remove-item-btn");
    if (!rmBtn) return;

    const productId = rmBtn.dataset.productId;

    sendCartAction(
        "{% url 'remove_from_cart' %}",
        `product_id=${productId}`,
        "removing item"
    );


    const itemDiv = rmBtn.closest('.cart_3l1');
    if (itemDiv) itemDiv.remove();
});

document.addEventListener("click", function (e) {
    if (!e.target.classList.contains("update-item")) return;

    let productId = e.target.dataset.productId;
    let qtyInput = document.querySelector(
        `.qty-input[data-product-id="${productId}"]`
    );
    let newQty = qtyInput.value;

    sendCartAction(
        "{% url 'update_cart_quantity' %}",
        `product_id=${productId}&quantity=${newQty}`,
        "updating quantity"
    );
});

document.addEventListener("DOMContentLoaded", function () {
    const addToCartButton = document.getElementById("add-to-cart");
    if (!addToCartButton) return;

    addToCartButton.addEventListener("click", function (e) {
        e.preventDefault();

        const productId = this.dataset.productId;
        const quantity = document.getElementById("cart-quantity").value;

        sendCartAction(
            "{% url 'add_to_cart' %}",
            `product_id=${productId}&quantity=${quantity}`,
            "adding item"
        );
    });
});


function sendCartAction(url, body, actionName) {
    fetch(url, {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: body,
    })
        .then((res) => res.json())
        .then((data) => {
            if (data.error) {
                alert(`Error while ${actionName}: ${data.error}`);
                return;
            }

            document.getElementById("cart-count").textContent =
                `${data.count} ITEMS`;
            document.getElementById("cart-total").textContent =
                `$${data.total.toFixed(2)}`;

  
            const subtotalEl = document.querySelector('.cart_3r h5.text-center.col_red');
            if (subtotalEl) {
                subtotalEl.textContent = `$${data.total.toFixed(2)}`;
            }

            data.items.forEach(item => {
                const inputEl = document.querySelector(`.qty-input[data-product-id="${item.id}"]`);
                if (inputEl) inputEl.value = item.qty;
            });

            const itemsContainer = document.getElementById("cart-items");
            if (data.items.length === 0) {
                itemsContainer.innerHTML =
                    `<p class="text-center mt-2">Your cart is empty</p>`;
            } else {
                let html = "";
                data.items.forEach((item) => {
                    html += `
                        <div class="drop_1i1 row">
                            <div class="col-md-6 col-6">
                                <div class="drop_1i1l">
                                    <h6>
                                        <a href="#">${item.name}</a><br>
                                        <span class="fw-normal d-inline-block mt-1">
                                            ${item.qty}x - $${item.price}
                                        </span>
                                    </h6>
                                </div>
                            </div>
                            <div class="col-md-4 col-4">
                                <div class="drop_1i1r">
                                    <img src="${item.image}" class="w-100">
                                </div>
                            </div>
                            <div class="col-md-2 col-2">
                                <div class="drop_1i1l text-end">
                                    <h6>
                                        <span class="remove-item-btn" data-product-id="${item.id}" style="cursor:pointer;">
                                            <i class="fa fa-trash"></i>
                                        </span>
                                    </h6>
                                </div>
                            </div>
                        </div>
                    `;
                });

                itemsContainer.innerHTML = html;
            }
        })
        .catch((err) => {
            console.error(err);
            alert("Something went wrong!");
        });
}

</script>
