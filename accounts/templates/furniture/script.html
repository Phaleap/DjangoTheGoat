<script>

window.onscroll = function() {
    stickyNavbar();
};

// Get the navbar element by its ID
var navbar = document.getElementById("navbar_sticky");

// Get the offset position of the navbar
var sticky = navbar.offsetTop;

function stickyNavbar() {
    if (window.pageYOffset > sticky) {
        navbar.classList.add("sticky");
    } else {
        navbar.classList.remove("sticky");
    }
}

document.addEventListener("click", function (e) {
    const rmBtn = e.target.closest(".remove-item-btn");
    if (!rmBtn) return;

    const productId = rmBtn.dataset.productId;

    sendCartAction(
        "{% url 'remove_from_cart' %}",
        `product_id=${productId}`,
        "removing item"
    );


    const itemDiv = rmBtn.closest('.cart_3l1');
    if (itemDiv) itemDiv.remove();
});

document.addEventListener("click", function (e) {
    if (!e.target.classList.contains("update-item")) return;

    let productId = e.target.dataset.productId;
    let qtyInput = document.querySelector(
        `.qty-input[data-product-id="${productId}"]`
    );
    let newQty = qtyInput.value;

    sendCartAction(
        "{% url 'update_cart_quantity' %}",
        `product_id=${productId}&quantity=${newQty}`,
        "updating quantity"
    );
});

document.addEventListener("DOMContentLoaded", function () {
    const addToCartButton = document.getElementById("add-to-cart");
    if (!addToCartButton) return;

    addToCartButton.addEventListener("click", function (e) {
        e.preventDefault();

        const productId = this.dataset.productId;
        const quantity = document.getElementById("cart-quantity").value;

        sendCartAction(
            "{% url 'add_to_cart' %}",
            `product_id=${productId}&quantity=${quantity}`,
            "adding item"
        );
    });
});

function sendCartAction(url, body, actionName) {
    fetch(url, {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: body,
    })
        .then((res) => res.json())
        .then((data) => {
            if (data.error) {
                alert(`Error while ${actionName}: ${data.error}`);
                return;
            }

            // 1. Update general counts and totals
            document.getElementById("cart-count").textContent = `${data.count} ITEMS`;
            document.getElementById("cart-total").textContent = `$${data.total.toFixed(2)}`;

            // 2. Update Navbar Cart Badge
            const cartBadgeEl = document.getElementById("cart-count-badge");
            if (cartBadgeEl) {
                cartBadgeEl.textContent = data.count; 
                cartBadgeEl.style.display = data.count > 0 ? 'inline-block' : 'none';
            }
            
            // 3. Update Subtotal on the Cart Page
            const subtotalEl = document.querySelector('.cart_3r h5.text-center.col_red');
            if (subtotalEl) {
                subtotalEl.textContent = `$${data.total.toFixed(2)}`;
            }

            // 4. Update individual item quantities if they exist
            data.items.forEach(item => {
                const inputEl = document.querySelector(`.qty-input[data-product-id="${item.id}"]`);
                if (inputEl) inputEl.value = item.qty;
            });

            // 5. Handle the Checkout Button and Empty State
            const checkoutBtn = document.getElementById("checkout-btn");
            if (checkoutBtn) {
                if (data.count === 0) {
                    // Disable the button
                    checkoutBtn.classList.add("disabled");
                    checkoutBtn.setAttribute("href", "#");
                    // Add the alert if they try to click it
                    checkoutBtn.onclick = function(e) {
                        e.preventDefault();
                        alert('Your cart is empty!');
                        return false;
                    };
                } else {
                    // Enable the button
                    checkoutBtn.classList.remove("disabled");
                    checkoutBtn.setAttribute("href", "{% url 'checkout' %}");
                    checkoutBtn.onclick = null; // Remove the alert
                }
            }

            // 6. Update the Cart Dropdown items
            const itemsContainer = document.getElementById("cart-items");
            if (data.items.length === 0) {
                itemsContainer.innerHTML = `<p class="text-center mt-2">Your cart is empty</p>`;
                
                // Also update the main cart list if the user is on the cart page
                const mainCartList = document.getElementById("main-cart-list");
                if (mainCartList) {
                    mainCartList.innerHTML = '<p>Your cart is empty.</p>';
                }
            } else {
                let html = "";
                data.items.forEach((item) => {
                    html += `
                        <div class="drop_1i1 row">
                            <div class="col-md-6 col-6">
                                <div class="drop_1i1l">
                                    <h6>
                                        <a href="#">${item.name}</a><br>
                                        <span class="fw-normal d-inline-block mt-1">
                                            ${item.qty}x - $${item.price}
                                        </span>
                                    </h6>
                                </div>
                            </div>
                            <div class="col-md-4 col-4">
                                <div class="drop_1i1r">
                                    <img src="${item.image}" class="w-100">
                                </div>
                            </div>
                            <div class="col-md-2 col-2">
                                <div class="drop_1i1l text-end">
                                    <h6>
                                        <span class="remove-item-btn" data-product-id="${item.id}" style="cursor:pointer;">
                                            <i class="fa fa-trash"></i>
                                        </span>
                                    </h6>
                                </div>
                            </div>
                        </div>
                    `;
                });
                itemsContainer.innerHTML = html;
            }
        })
        .catch((err) => {
            console.error(err);
            alert("Something went wrong!");
        });
}

let dropArea = document.getElementById("dropArea");
let fileInput = document.getElementById("fileInput");
let preview = document.getElementById("preview");

fileInput.addEventListener("change", function () {
    showFile(this.files[0]);
});

dropArea.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropArea.classList.add("active");
});

dropArea.addEventListener("dragleave", () => {
    dropArea.classList.remove("active");
});

dropArea.addEventListener("drop", (e) => {
    e.preventDefault();
    dropArea.classList.remove("active");

    let file = e.dataTransfer.files[0];
    fileInput.files = e.dataTransfer.files;

    showFile(file);
});

function showFile(file) {
    let validExtensions = ["image/jpeg", "image/jpg", "image/png"];
    if (validExtensions.includes(file.type)) {
        let fileReader = new FileReader();

        fileReader.onload = () => {
            preview.classList.remove("d-none");
            preview.innerHTML = `<img src="${fileReader.result}" alt="Preview">`;
        };

        fileReader.readAsDataURL(file);
    } else {
        alert("Invalid file type! Only images allowed.");
    }
}
document.querySelectorAll(".category-btn").forEach((btn) => {
        btn.addEventListener("click", function (e) {
          e.preventDefault();
          const filter = this.getAttribute("data-filter");
          const products = document.querySelectorAll(".product-item");

          products.forEach((item) => {
            if (filter === "all" || item.getAttribute("data-category") === filter) {
              item.style.display = "block";
            } else {
              item.style.display = "none";
            }
          });
        });
      });

const form = document.querySelector('form');
form.addEventListener('submit', function(e) {
    const fileInput = document.getElementById('fileInput');
    if (!fileInput.files.length) {
        e.preventDefault();
        alert('Please upload your payment receipt before placing the order.');
    }
});

</script>
